# üö´ [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏´‡∏£‡∏∑‡∏≠ generate Codacy CLI/Scanner ‡πÉ‡∏ô workflow ‡∏ô‡∏µ‡πâ
# ‚úÖ [‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö] ‡πÉ‡∏ä‡πâ ESLint (JS/TS) ‡∏´‡∏£‡∏∑‡∏≠ Flake8 (Python) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö static analysis
# ‡∏´‡∏≤‡∏Å‡∏û‡∏ö Codacy, PR ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
#
# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Workflow ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JS/TS):
# name: Lint & Static Analysis
# on: [push, pull_request]
# jobs:
#   lint:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#       - run: npm ci
#       - run: npx eslint . --ext .js,.ts --max-warnings=0

name: Smart Documentation Sync

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    
jobs:
  smart-sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    # === ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ===
    - name: Auto Cleanup Test Files
      run: |
        echo "üßπ Running auto cleanup..."
        npm run cleanup || echo "‚ö†Ô∏è Cleanup failed but continuing..."

    # === ‡∏™‡∏£‡πâ‡∏≤‡∏á Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡πà‡∏≠‡∏¢ ===
    - name: Generate Project Cache
      run: |
        echo "üíæ Generating project cache..."
        node -e "
        const fs = require('fs');
        const path = require('path');
        
        const projectData = {
          timestamp: new Date().toISOString(),
          structure: {},
          tools: [],
          databases: {},
          scripts: {},
          documentation: {}
        };
        
        // ‡∏≠‡πà‡∏≤‡∏ô package.json
        try {
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          projectData.scripts = pkg.scripts;
          projectData.dependencies = pkg.dependencies;
          projectData.devDependencies = pkg.devDependencies;
        } catch (e) {}
        
        // ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        const importantFiles = [
          'README.md', 'ROADMAP-UPDATED.md', 'FRONTEND-API-GUIDE.md',
          '.env.example', 'package.json'
        ];
        
        importantFiles.forEach(file => {
          try {
            if (fs.existsSync(file)) {
              const content = fs.readFileSync(file, 'utf8');
              projectData.documentation[file] = {
                size: content.length,
                lines: content.split('\n').length,
                lastModified: fs.statSync(file).mtime
              };
            }
          } catch (e) {}
        });
        
        // ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
        const jsFiles = fs.readdirSync('.').filter(f => f.endsWith('.js') && !f.startsWith('test-'));
        projectData.tools = jsFiles.map(f => ({
          name: f,
          size: fs.statSync(f).size,
          lastModified: fs.statSync(f).mtime
        }));
        
        fs.writeFileSync('.github/project-cache.json', JSON.stringify(projectData, null, 2));
        console.log('‚úÖ Project cache generated');
        "

    # === ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ===
    - name: Auto Update Documentation
      run: |
        echo "üìù Auto updating documentation..."
        
        # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ
        node -e "
        const fs = require('fs');
        
        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
        const jsFiles = fs.readdirSync('.').filter(f => f.endsWith('.js') && !f.startsWith('test-'));
        const checkFiles = jsFiles.filter(f => f.startsWith('check-'));
        const toolFiles = jsFiles.filter(f => !f.startsWith('check-') && !f.startsWith('test-'));
        
        const stats = {
          totalFiles: jsFiles.length,
          checkTools: checkFiles.length,
          otherTools: toolFiles.length,
          updated: new Date().toLocaleString('th-TH')
        };
        
        console.log('üìä Project Statistics:');
        console.log('   Total JS Files:', stats.totalFiles);
        console.log('   Check Tools:', stats.checkTools);
        console.log('   Other Tools:', stats.otherTools);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï README footer
        try {
          let readme = fs.readFileSync('README.md', 'utf8');
          const footerRegex = /---\n\*.*‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥.*\*/;
          const newFooter = '---\\n*‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢ GitHub Actions | ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + stats.totalFiles + ' | ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' + stats.updated + '*';
          
          if (footerRegex.test(readme)) {
            readme = readme.replace(footerRegex, newFooter);
          } else {
            readme += '\n\n' + newFooter;
          }
          
          fs.writeFileSync('README.md', readme);
          console.log('‚úÖ README footer updated');
        } catch (e) {
          console.log('‚ö†Ô∏è README update failed:', e.message);
        }
        "

    # === ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ ===
    - name: Project Health Check
      run: |
        echo "üè• Running project health check..."
        
        node -e "
        const fs = require('fs');
        
        const healthReport = {
          timestamp: new Date().toISOString(),
          status: 'healthy',
          issues: [],
          recommendations: []
        };
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        const criticalFiles = [
          'package.json', 'README.md', 'server/app.js', 
          'src/tools/index.ts', '.env.example'
        ];
        
        criticalFiles.forEach(file => {
          if (!fs.existsSync(file)) {
            healthReport.issues.push(\`Missing critical file: \${file}\`);
            healthReport.status = 'warning';
          }
        });
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö dependencies
        try {
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const deps = Object.keys(pkg.dependencies || {});
          
          if (deps.length === 0) {
            healthReport.issues.push('No dependencies found');
          }
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö scripts ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
          const importantScripts = ['build', 'start-gateway', 'cleanup'];
          importantScripts.forEach(script => {
            if (!pkg.scripts || !pkg.scripts[script]) {
              healthReport.issues.push(\`Missing important script: \${script}\`);
            }
          });
          
        } catch (e) {
          healthReport.issues.push('Cannot read package.json');
          healthReport.status = 'error';
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö environment variables
        try {
          const envExample = fs.readFileSync('.env.example', 'utf8');
          const envVars = envExample.match(/^[A-Z_]+=.*/gm) || [];
          
          if (envVars.length < 5) {
            healthReport.recommendations.push('Consider adding more environment variables examples');
          }
        } catch (e) {
          healthReport.issues.push('Cannot read .env.example');
        }
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        fs.writeFileSync('.github/health-report.json', JSON.stringify(healthReport, null, 2));
        
        console.log('üè• Health Check Results:');
        console.log('Status:', healthReport.status);
        console.log('Issues:', healthReport.issues.length);
        console.log('Recommendations:', healthReport.recommendations.length);
        
        if (healthReport.issues.length > 0) {
          console.log('‚ùå Issues found:');
          healthReport.issues.forEach(issue => console.log('  -', issue));
        }
        
        if (healthReport.recommendations.length > 0) {
          console.log('üí° Recommendations:');
          healthReport.recommendations.forEach(rec => console.log('  -', rec));
        }
        "

    # === ‡∏™‡∏£‡πâ‡∏≤‡∏á API Documentation ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ===
    - name: Generate API Documentation
      run: |
        echo "üìñ Generating API documentation..."
        
        node -e "
        const fs = require('fs');
        const path = require('path');
        
        let apiDocs = '# üìñ Auto-Generated API Documentation\n\n';
        apiDocs += \`Generated: \${new Date().toLocaleString('th-TH')}\n\n\`;
        
        // ‡∏™‡πÅ‡∏Å‡∏ô server endpoints
        try {
          const serverPath = 'server/app.js';
          if (fs.existsSync(serverPath)) {
            const serverContent = fs.readFileSync(serverPath, 'utf8');
            
            // ‡∏´‡∏≤ endpoints
            const endpoints = [];
            const routeMatches = serverContent.match(/app\.(get|post|put|delete)\(['\"](.*?)['\"]/g) || [];
            
            routeMatches.forEach(match => {
              const methodMatch = match.match(/app\.(\w+)/);
              const pathMatch = match.match(/['\"](.*?)['\"]$/);
              
              if (methodMatch && pathMatch) {
                endpoints.push({
                  method: methodMatch[1].toUpperCase(),
                  path: pathMatch[1]
                });
              }
            });
            
            if (endpoints.length > 0) {
              apiDocs += '## üåê API Endpoints\n\n';
              endpoints.forEach(ep => {
                apiDocs += \`- **\${ep.method}** \\\`\${ep.path}\\\`\n\`;
              });
              apiDocs += '\n';
            }
          }
        } catch (e) {
          console.log('‚ö†Ô∏è Could not scan server endpoints');
        }
        
        // ‡∏™‡πÅ‡∏Å‡∏ô MCP tools
        try {
          const toolsPath = 'src/tools';
          if (fs.existsSync(toolsPath)) {
            const toolFiles = fs.readdirSync(toolsPath).filter(f => f.endsWith('.ts'));
            
            if (toolFiles.length > 0) {
              apiDocs += '## üõ†Ô∏è MCP Tools\n\n';
              toolFiles.forEach(file => {
                apiDocs += \`- \\\`\${file}\\\`\n\`;
              });
              apiDocs += '\n';
            }
          }
        } catch (e) {
          console.log('‚ö†Ô∏è Could not scan MCP tools');
        }
        
        // ‡∏™‡πÅ‡∏Å‡∏ô scripts
        try {
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          if (pkg.scripts) {
            apiDocs += '## ‚ö° Available Scripts\n\n';
            Object.entries(pkg.scripts).forEach(([name, command]) => {
              apiDocs += \`- **\${name}**: \\\`\${command}\\\`\n\`;
            });
            apiDocs += '\n';
          }
        } catch (e) {
          console.log('‚ö†Ô∏è Could not read scripts');
        }
        
        fs.writeFileSync('.github/api-docs.md', apiDocs);
        console.log('‚úÖ API documentation generated');
        "

    # === ‡∏™‡∏£‡πâ‡∏≤‡∏á Performance Report ===
    - name: Performance Analysis
      run: |
        echo "‚ö° Analyzing performance..."
        
        node -e "
        const fs = require('fs');
        
        const perfReport = {
          timestamp: new Date().toISOString(),
          fileAnalysis: {},
          recommendations: []
        };
        
        // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
        const jsFiles = fs.readdirSync('.').filter(f => f.endsWith('.js'));
        let totalSize = 0;
        
        jsFiles.forEach(file => {
          const stats = fs.statSync(file);
          const sizeKB = Math.round(stats.size / 1024);
          
          perfReport.fileAnalysis[file] = {
            sizeKB: sizeKB,
            lines: fs.readFileSync(file, 'utf8').split('\n').length
          };
          
          totalSize += stats.size;
          
          // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
          if (sizeKB > 50) {
            perfReport.recommendations.push(\`Consider breaking down \${file} (large file: \${sizeKB}KB)\`);
          }
        });
        
        perfReport.totalSizeKB = Math.round(totalSize / 1024);
        
        // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå dependencies
        try {
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const deps = Object.keys(pkg.dependencies || {});
          const devDeps = Object.keys(pkg.devDependencies || {});
          
          perfReport.dependencyAnalysis = {
            production: deps.length,
            development: devDeps.length,
            total: deps.length + devDeps.length
          };
          
          if (deps.length > 20) {
            perfReport.recommendations.push('Consider reducing production dependencies');
          }
          
        } catch (e) {}
        
        fs.writeFileSync('.github/performance-report.json', JSON.stringify(perfReport, null, 2));
        
        console.log('‚ö° Performance Analysis:');
        console.log('Total Size:', perfReport.totalSizeKB, 'KB');
        console.log('Files Analyzed:', Object.keys(perfReport.fileAnalysis).length);
        console.log('Recommendations:', perfReport.recommendations.length);
        "

    # === Commit ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ===
    - name: Commit Auto Updates
      if: github.event_name == 'push' # Run only on push events
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if ! git diff --quiet; then
          echo "üìù Changes detected, committing..."
          # Checkout (or create) the correct branch before committing
          git checkout -B "${{ github.ref_name }}"
          git add .
          git commit -m "ü§ñ Auto-update: documentation, cleanup, and reports [skip ci]"
          git push
          echo "‚úÖ Changes committed and pushed"
        else
          echo "‚ú® No changes to commit"
        fi

    # === ‡∏™‡∏£‡πâ‡∏≤‡∏á Summary Report ===
    - name: Generate Summary Report
      run: |
        echo "üìä Generating summary report..."
        
        node -e "
        const fs = require('fs');
        
        const summary = {
          timestamp: new Date().toLocaleString('th-TH'),
          actions: {
            cleanup: 'Completed',
            documentation: 'Updated',
            healthCheck: 'Completed',
            apiDocs: 'Generated',
            performance: 'Analyzed'
          },
          nextSteps: [
            'Review health report for any issues',
            'Check performance recommendations',
            'Update documentation if needed'
          ]
        };
        
        let report = '# üöÄ GitHub Actions Summary Report\n\n';
        report += \`**Execution Time**: \${summary.timestamp}\n\n\`;
        
        report += '## ‚úÖ Actions Completed\n\n';
        Object.entries(summary.actions).forEach(([action, status]) => {
          report += \`- **\${action}**: \${status}\n\`;
        });
        
        report += '\n## üìã Next Steps\n\n';
        summary.nextSteps.forEach(step => {
          report += \`- \${step}\n\`;
        });
        
        report += '\n---\n*Generated by Smart Documentation Sync*';
        
        fs.writeFileSync('.github/summary-report.md', report);
        console.log('üìä Summary report generated');
        console.log(report);
        "

    # === ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô Slack/Discord (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ===uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    # === ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ===
    - name: Auto Cleanup Test Files
      run: |
        echo "üßπ Running auto cleanup..."
        npm run cleanup || echo "‚ö†Ô∏è Cleanup failed but continuing..."

    # === ‡∏™‡∏£‡πâ‡∏≤‡∏á Cache ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡πà‡∏≠‡∏¢ ===
    - name: Generate Project Cache
      run: |
        echo "üíæ Generating project cache..."
        node -e "
        const fs = require('fs');
        const path = require('path');
        
        const projectData = {
          timestamp: new Date().toISOString(),
          structure: {},
          tools: [],
          databases: {},
          scripts: {},
          documentation: {}
        };
        
        // ‡∏≠‡πà‡∏≤‡∏ô package.json
        try {
          const packageJsonPath = path.resolve(__dirname, 'package.json');
          const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));
          projectData.structure = packageJson;
        } catch (error) {
          console.error('‚ùå Error reading package.json:', error);
        }
    # === ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô Slack/Discord (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ===

    - name: Send Notification
      if: failure()
      run: |
        echo "üö® Workflow failed - check logs for details"
        # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô webhook ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£

    # === Fix detached HEAD (checkout branch) ===
    - name: Fix detached HEAD (checkout branch)
      run: |
        BRANCH_NAME="${GITHUB_REF_NAME:-main}"
        git fetch origin $BRANCH_NAME
        git checkout $BRANCH_NAME || git checkout -b $BRANCH_NAME origin/$BRANCH_NAME
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
