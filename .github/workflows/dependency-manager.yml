name: Smart Dependency Manager

on:
  schedule:
    - cron: '0 2 * * 1'  # à¸—à¸¸à¸à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œà¹€à¸§à¸¥à¸² 02:00
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - security

jobs:
  dependency-analysis:
    runs-on: ubuntu-latest
    
    outputs:
      has-updates: ${{ steps.check-updates.outputs.has-updates }}
      security-issues: ${{ steps.security-check.outputs.security-issues }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    # === à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Dependencies ===
    - name: Check for Updates
      id: check-updates
      run: |
        echo "ğŸ” Checking for dependency updates..."
        
        # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ npm-check-updates
        npm install -g npm-check-updates
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š updates
        ncu --jsonUpgraded > .github/dependency-updates.json || echo "{}" > .github/dependency-updates.json
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µ updates à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
        if [ -s .github/dependency-updates.json ] && [ "$(cat .github/dependency-updates.json)" != "{}" ]; then
          echo "has-updates=true" >> $GITHUB_OUTPUT
          echo "âœ… Updates found"
        else
          echo "has-updates=false" >> $GITHUB_OUTPUT
          echo "âœ¨ All dependencies up to date"
        fi

    # === à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Security ===
    - name: Security Audit
      id: security-check
      run: |
        echo "ğŸ”’ Running security audit..."
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š vulnerabilities
        npm audit --json > .github/security-audit.json || true
        
        # à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
        node -e "
        const fs = require('fs');
        
        try {
          const auditResult = JSON.parse(fs.readFileSync('.github/security-audit.json', 'utf8'));
          
          const report = {
            timestamp: new Date().toISOString(),
            totalVulnerabilities: auditResult.metadata?.vulnerabilities?.total || 0,
            critical: auditResult.metadata?.vulnerabilities?.critical || 0,
            high: auditResult.metadata?.vulnerabilities?.high || 0,
            moderate: auditResult.metadata?.vulnerabilities?.moderate || 0,
            low: auditResult.metadata?.vulnerabilities?.low || 0,
            info: auditResult.metadata?.vulnerabilities?.info || 0
          };
          
          fs.writeFileSync('.github/security-report.json', JSON.stringify(report, null, 2));
          
          if (report.totalVulnerabilities > 0) {
            console.log('ğŸš¨ Security issues found:', report.totalVulnerabilities);
            console.log('security-issues=true');
          } else {
            console.log('âœ… No security vulnerabilities found');
            console.log('security-issues=false');
          }
          
        } catch (e) {
          console.log('âš ï¸ Could not parse audit results');
          console.log('security-issues=false');
        }
        " >> $GITHUB_OUTPUT

    # === à¸ªà¸£à¹‰à¸²à¸‡ Dependency Report ===
    - name: Generate Dependency Report
      run: |
        echo "ğŸ“Š Generating dependency report..."
        
        node -e "
        const fs = require('fs');
        
        let report = '# ğŸ“¦ Dependency Analysis Report\n\n';
        report += \`Generated: \${new Date().toLocaleString('th-TH')}\n\n\`;
        
        // à¸­à¹ˆà¸²à¸™ package.json
        try {
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          
          const deps = Object.keys(pkg.dependencies || {});
          const devDeps = Object.keys(pkg.devDependencies || {});
          
          report += '## ğŸ“ˆ Dependency Summary\n\n';
          report += \`- **Production Dependencies**: \${deps.length}\n\`;
          report += \`- **Development Dependencies**: \${devDeps.length}\n\`;
          report += \`- **Total**: \${deps.length + devDeps.length}\n\n\`;
          
          // à¸£à¸²à¸¢à¸à¸²à¸£ dependencies
          if (deps.length > 0) {
            report += '## ğŸš€ Production Dependencies\n\n';
            deps.forEach(dep => {
              const version = pkg.dependencies[dep];
              report += \`- **\${dep}**: \${version}\n\`;
            });
            report += '\n';
          }
          
        } catch (e) {
          report += 'âŒ Could not read package.json\n\n';
        }
        
        // à¸­à¹ˆà¸²à¸™ security report
        try {
          const security = JSON.parse(fs.readFileSync('.github/security-report.json', 'utf8'));
          
          report += '## ğŸ”’ Security Status\n\n';
          if (security.totalVulnerabilities === 0) {
            report += 'âœ… No security vulnerabilities found\n\n';
          } else {
            report += \`âš ï¸ **Total Vulnerabilities**: \${security.totalVulnerabilities}\n\`;
            if (security.critical > 0) report += \`- ğŸ”´ Critical: \${security.critical}\n\`;
            if (security.high > 0) report += \`- ğŸŸ  High: \${security.high}\n\`;
            if (security.moderate > 0) report += \`- ğŸŸ¡ Moderate: \${security.moderate}\n\`;
            if (security.low > 0) report += \`- ğŸŸ¢ Low: \${security.low}\n\`;
            report += '\n';
          }
        } catch (e) {
          report += 'âŒ Could not read security report\n\n';
        }
        
        // à¸­à¹ˆà¸²à¸™ available updates
        try {
          const updates = JSON.parse(fs.readFileSync('.github/dependency-updates.json', 'utf8'));
          
          if (Object.keys(updates).length > 0) {
            report += '## ğŸ”„ Available Updates\n\n';
            Object.entries(updates).forEach(([pkg, version]) => {
              report += \`- **\${pkg}**: \${version}\n\`;
            });
            report += '\n';
          } else {
            report += '## âœ… All Dependencies Up to Date\n\n';
          }
        } catch (e) {
          report += 'âŒ Could not read update information\n\n';
        }
        
        fs.writeFileSync('.github/dependency-report.md', report);
        console.log('ğŸ“Š Dependency report generated');
        "

    # === Upload Reports as Artifacts ===
    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: .github/*-report.*

  # === Auto-Update Dependencies (à¸–à¹‰à¸²à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢) ===
  auto-update:
    runs-on: ubuntu-latest
    needs: dependency-analysis
    if: needs.dependency-analysis.outputs.has-updates == 'true' && needs.dependency-analysis.outputs.security-issues == 'false'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Update Dependencies
      run: |
        echo "ğŸ”„ Updating dependencies..."
        
        # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ tools
        npm install -g npm-check-updates
        
        # à¸­à¸±à¸›à¹€à¸”à¸•à¸•à¸²à¸¡ input type
        UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"
        
        case $UPDATE_TYPE in
          "patch")
            echo "ğŸ”§ Updating patch versions only..."
            ncu -u --target patch
            ;;
          "minor")
            echo "ğŸ”§ Updating minor versions..."
            ncu -u --target minor
            ;;
          "major")
            echo "ğŸ”§ Updating all versions (careful!)..."
            ncu -u
            ;;
          "security")
            echo "ğŸ”’ Updating security vulnerabilities only..."
            npm audit fix --force
            ;;
        esac

    - name: Install Updated Dependencies
      run: npm install

    - name: Run Tests
      run: |
        echo "ğŸ§ª Running tests after updates..."
        npm test || echo "âš ï¸ Tests failed, but continuing..."

    - name: Build Project
      run: |
        echo "ğŸ—ï¸ Building project after updates..."
        npm run build

    - name: Commit Updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Dependency Update Bot"
        
        if ! git diff --quiet package.json package-lock.json; then
          echo "ğŸ“ Committing dependency updates..."
          git add package.json package-lock.json
          git commit -m "ğŸ”„ Auto-update dependencies [${{ github.event.inputs.update_type || 'patch' }}] [skip ci]"
          git push
          echo "âœ… Dependencies updated and committed"
        else
          echo "âœ¨ No dependency changes to commit"
        fi
